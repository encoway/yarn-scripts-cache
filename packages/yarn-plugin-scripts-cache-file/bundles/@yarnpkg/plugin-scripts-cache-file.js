/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-scripts-cache-file",
factory: function (require) {
"use strict";var plugin=(()=>{var G=Object.create;var d=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var f=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var h=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),J=(t,e)=>{for(var r in e)d(t,r,{get:e[r],enumerable:!0})},b=(t,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of X(e))!K.call(t,n)&&n!==r&&d(t,n,{get:()=>e[n],enumerable:!(a=k(e,n))||a.enumerable});return t};var I=(t,e,r)=>(r=t!=null?G(q(t)):{},b(e||!t||!t.__esModule?d(r,"default",{value:t,enumerable:!0}):r,t)),$=t=>b(d({},"__esModule",{value:!0}),t);var y=h(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0})});var F=h(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0})});var S=h(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0})});var w=h(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.readIntConfigValue=z;C.readStringConfigValue=Q;C.readBooleanConfigValue=Z;function z(t,e,r,a,n){let o=process.env[r];return o&&!isNaN(parseInt(o))?parseInt(o):t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="number"?t.cacheConfigs[e][a]:n}function Q(t,e,r,a,n){let o=process.env[r];return o||(t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="string"?t.cacheConfigs[e][a]:n)}function Z(t,e,r,a,n){let o=process.env[r];return o?o==="true":t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="boolean"?t.cacheConfigs[e][a]:n}});var V=h(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0})});var v=h(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0})});var U=h(s=>{"use strict";var ee=s&&s.__createBinding||(Object.create?function(t,e,r,a){a===void 0&&(a=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,a,n)}:function(t,e,r,a){a===void 0&&(a=r),t[a]=e[r]}),E=s&&s.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&ee(e,t,r)};Object.defineProperty(s,"__esModule",{value:!0});E(y(),s);E(F(),s);E(S(),s);E(w(),s);E(V(),s);E(v(),s)});var Ve={};J(Ve,{default:()=>Me});var D=f("@yarnpkg/core");var i=f("@yarnpkg/fslib"),m=f("@yarnpkg/core"),W=I(f("crypto")),c=I(U());var A=f("@yarnpkg/fslib"),_=f("@yarnpkg/core");async function j(t,e,r){let a;try{a=await te(t)}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error reading lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}if(a===null)return B(t,Date.now(),r);if(!Number.isNaN(a)&&a+e>Date.now())return!1;try{await A.xfs.unlinkPromise(t)}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error deleting lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}return B(t,Date.now(),r)}async function te(t){try{let e=await A.xfs.readFilePromise(t,"utf-8");return parseInt(e,10)}catch(e){if(e.code==="ENOENT")return null;throw e}}async function B(t,e,r){try{return await A.xfs.writeFilePromise(t,e.toString(),{flag:"wx"}),!0}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error writing lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}}var l="file",re=10,x="last-cleanup.txt",ae="YSC_FILE_DISABLED",ne="cacheDisabled",ie=!1,oe="YSC_FILE_READ_DISABLED",se="cacheReadDisabled",ce=!1,ue="YSC_FILE_WRITE_DISABLED",le="cacheWriteDisabled",he=!1,fe="YSC_FILE_MAX_AGE",Ee="maxAge",Ce=2592e6,pe="YSC_FILE_MAX_AMOUNT",de="maxAmount",_e=1e3,Ae="YSC_FILE_CLEANUP_COOLDOWN",ge="cleanupCooldown",De=864e5,me="YSC_FILE_CACHE_FOLDER_NAME",Ne="cacheFolderName",Le="yarn-scripts-cache",be="YSC_FILE_CACHE_FOLDER_LOCATION",Ie="cacheFolderLocation",g=class{constructor(e,r,a,n){this.name=l,this.order=re,this.cwd=e,this.project=r,this.config=a,this.streamReport=n}async saveCacheEntry(e){if(this.getCacheDisabled()||this.getCacheWriteDisabled())return;let r=this.buildCacheDir();await i.xfs.mkdirPromise(r,{recursive:!0});let a=this.buildCacheFile(r,e.key),n=JSON.stringify(e);await i.xfs.writeFilePromise(a,n),await this.cleanup()}async loadCacheEntry(e){if(this.getCacheDisabled()||this.getCacheReadDisabled())return;let r=this.buildCacheDir();if(!await i.xfs.existsPromise(r))return;let a=this.buildCacheFile(r,e),n=await Pe(a,"utf8");if(!n)return;let o=JSON.parse(n);if(Oe(e,o.key))return o}async cleanup(){let e=this.getMaxAge(),r=this.getMaxAmount(),a=this.getCleanupCooldown(),n=Date.now()-e,o=this.buildCacheDir(),H=i.ppath.join(o,x);if(!await j(H,a,this.streamReport))return;let N=(await i.xfs.readdirPromise(o)).filter(u=>u!==x).map(u=>i.ppath.join(o,u)).map(ye);N.sort((u,Y)=>Y.creationDate-u.creationDate);let L=0,p=0;for(let u of N)u.creationDate<n?(await i.xfs.unlinkPromise(u.file),p+=1):L+=1,L>r&&(await i.xfs.unlinkPromise(u.file),p+=1);p>0?this.streamReport.reportInfo(m.MessageName.UNNAMED,`File cache cleanup executed successfully. Deleted ${p} file(s).`):this.streamReport.reportInfo(m.MessageName.UNNAMED,"File cache cleanup executed successfully. No files need to be cleaned up.")}buildCacheFile(e,r){let a=W.default.createHash("sha512");return a.update(JSON.stringify(r)),i.ppath.join(e,`${a.digest("base64url")}.json`)}buildCacheDir(){let e=this.getCacheFolderLocation();if(e){let a=i.npath.toPortablePath(e);return i.npath.isAbsolute(e)?a:i.ppath.join(this.cwd,a)}let r=this.project.configuration.get("globalFolder");return i.ppath.join(r,this.getCacheFolderName())}getCacheDisabled(){return(0,c.readBooleanConfigValue)(this.config,l,ae,ne,ie)}getCacheReadDisabled(){return(0,c.readBooleanConfigValue)(this.config,l,oe,se,ce)}getCacheWriteDisabled(){return(0,c.readBooleanConfigValue)(this.config,l,ue,le,he)}getMaxAge(){return(0,c.readIntConfigValue)(this.config,l,fe,Ee,Ce)}getMaxAmount(){return(0,c.readIntConfigValue)(this.config,l,pe,de,_e)}getCleanupCooldown(){return(0,c.readIntConfigValue)(this.config,l,Ae,ge,De)}getCacheFolderName(){return(0,c.readStringConfigValue)(this.config,l,me,Ne,Le)}getCacheFolderLocation(){return(0,c.readStringConfigValue)(this.config,l,be,Ie,void 0)}};function Oe(t,e){return JSON.stringify(t)===JSON.stringify(e)}function ye(t){let e=i.xfs.statSync(t);return{file:t,creationDate:e.mtime.getTime()}}async function Pe(t,e){try{return await i.xfs.readFilePromise(t,e)}catch(r){if(r.code==="ENOENT")return;throw r}}async function Fe(t){let e=D.Configuration.create(t.cwd);return D.StreamReport.start({configuration:e,includeFooter:!1,stdout:t.stdout},async()=>{})}var Re=async(t,e,r)=>{let a=await Fe(r.extra);t.push(new g(r.extra.cwd,r.project,e,a))},Se={beforeYarnScriptsCacheUsage:Re},we={hooks:Se},Me=we;return $(Ve);})();
return plugin;
}
};
