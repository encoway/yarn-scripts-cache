/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-scripts-cache-file",
factory: function (require) {
"use strict";var plugin=(()=>{var K=Object.create;var p=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var E=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var l=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Z=(t,e)=>{for(var r in e)p(t,r,{get:e[r],enumerable:!0})},L=(t,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of $(e))!Q.call(t,i)&&i!==r&&p(t,i,{get:()=>e[i],enumerable:!(a=J(e,i))||a.enumerable});return t};var I=(t,e,r)=>(r=t!=null?K(z(t)):{},L(e||!t||!t.__esModule?p(r,"default",{value:t,enumerable:!0}):r,t)),ee=t=>L(p({},"__esModule",{value:!0}),t);var O=l(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0})});var F=l(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0})});var S=l(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0})});var M=l(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.readIntConfigValue=te;C.readStringConfigValue=re;C.readBooleanConfigValue=ae;function te(t,e,r,a,i){let o=process.env[r];return o&&!isNaN(parseInt(o))?parseInt(o):t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="number"?t.cacheConfigs[e][a]:i}function re(t,e,r,a,i){let o=process.env[r];return o||(t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="string"?t.cacheConfigs[e][a]:i)}function ae(t,e,r,a,i){let o=process.env[r];return o?o==="true":t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][a]=="boolean"?t.cacheConfigs[e][a]:i}});var V=l(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0})});var T=l(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0})});var B=l(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0})});var x=l(j=>{"use strict";Object.defineProperty(j,"__esModule",{value:!0})});var W=l(s=>{"use strict";var ie=s&&s.__createBinding||(Object.create?function(t,e,r,a){a===void 0&&(a=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,a,i)}:function(t,e,r,a){a===void 0&&(a=r),t[a]=e[r]}),f=s&&s.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&ie(e,t,r)};Object.defineProperty(s,"__esModule",{value:!0});f(O(),s);f(F(),s);f(S(),s);f(M(),s);f(V(),s);f(T(),s);f(B(),s);f(x(),s)});var Be={};Z(Be,{default:()=>Ue});var D=E("@yarnpkg/core");var n=E("@yarnpkg/fslib"),m=E("@yarnpkg/core"),k=I(E("crypto")),c=I(W());var A=E("@yarnpkg/fslib"),_=E("@yarnpkg/core");async function Y(t,e,r){let a;try{a=await ne(t)}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error reading lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}if(a===null)return H(t,Date.now(),r);if(!Number.isNaN(a)&&a+e>Date.now())return!1;try{await A.xfs.unlinkPromise(t)}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error deleting lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}return H(t,Date.now(),r)}async function ne(t){try{let e=await A.xfs.readFilePromise(t,"utf-8");return parseInt(e,10)}catch(e){if(e.code==="ENOENT")return null;throw e}}async function H(t,e,r){try{return await A.xfs.writeFilePromise(t,e.toString(),{flag:"wx"}),!0}catch{return r.reportWarning(_.MessageName.UNNAMED,"Skipped file cache cleanup due to an error writing lockfile. This is probably fine and can happen when the cleanup is triggered in multiple processes/workspaces at the same time. If the cleanup NEVER succeeds, please report a bug to yarn-scripts-cache."),!1}}var h="file",oe=10,G="last-cleanup.txt",se="YSC_FILE_DISABLED",ce="cacheDisabled",ue=!1,le="YSC_FILE_READ_DISABLED",he="cacheReadDisabled",fe=!1,Ee="YSC_FILE_WRITE_DISABLED",Ce="cacheWriteDisabled",de=!1,pe="YSC_FILE_MAX_AGE",_e="maxAge",Ae=2592e6,ge="YSC_FILE_MAX_AMOUNT",De="maxAmount",me=1e3,be="YSC_FILE_CLEANUP_COOLDOWN",Ne="cleanupCooldown",Le=864e5,Ie="YSC_FILE_CACHE_FOLDER_NAME",ye="cacheFolderName",Oe="yarn-scripts-cache",Pe="YSC_FILE_CACHE_FOLDER_LOCATION",Fe="cacheFolderLocation",g=class{constructor(e,r,a,i){this.name=h,this.order=oe,this.cwd=e,this.project=r,this.config=a,this.streamReport=i}async saveCacheEntry(e){if(this.getCacheDisabled()||this.getCacheWriteDisabled())return;let r=this.buildCacheDir();await n.xfs.mkdirPromise(r,{recursive:!0});let a=this.buildCacheFile(r,e.key),i=JSON.stringify(e);await n.xfs.writeFilePromise(a,i),await this.cleanup()}async loadCacheEntry(e){if(this.getCacheDisabled()||this.getCacheReadDisabled())return;let r=this.buildCacheDir();if(!await n.xfs.existsPromise(r))return;let a=this.buildCacheFile(r,e),i=await Me(a,"utf8");if(!i)return;let o=JSON.parse(i);if(Re(e,o.key))return o}async cleanup(){let e=this.getMaxAge(),r=this.getMaxAmount(),a=this.getCleanupCooldown(),i=Date.now()-e,o=this.buildCacheDir(),q=n.ppath.join(o,G);if(!await Y(q,a,this.streamReport))return;let b=(await n.xfs.readdirPromise(o)).filter(u=>u!==G).map(u=>n.ppath.join(o,u)).map(Se);b.sort((u,X)=>X.creationDate-u.creationDate);let N=0,d=0;for(let u of b)u.creationDate<i?(await n.xfs.unlinkPromise(u.file),d+=1):N+=1,N>r&&(await n.xfs.unlinkPromise(u.file),d+=1);d>0?this.streamReport.reportInfo(m.MessageName.UNNAMED,`File cache cleanup executed successfully. Deleted ${d} file(s).`):this.streamReport.reportInfo(m.MessageName.UNNAMED,"File cache cleanup executed successfully. No files need to be cleaned up.")}buildCacheFile(e,r){let a=k.default.createHash("sha512");return a.update(JSON.stringify(r)),n.ppath.join(e,`${a.digest("base64url")}.json`)}buildCacheDir(){let e=this.getCacheFolderLocation();if(e){let a=n.npath.toPortablePath(e);return n.npath.isAbsolute(e)?a:n.ppath.join(this.cwd,a)}let r=this.project.configuration.get("globalFolder");return n.ppath.join(r,this.getCacheFolderName())}getCacheDisabled(){return(0,c.readBooleanConfigValue)(this.config,h,se,ce,ue)}getCacheReadDisabled(){return(0,c.readBooleanConfigValue)(this.config,h,le,he,fe)}getCacheWriteDisabled(){return(0,c.readBooleanConfigValue)(this.config,h,Ee,Ce,de)}getMaxAge(){return(0,c.readIntConfigValue)(this.config,h,pe,_e,Ae)}getMaxAmount(){return(0,c.readIntConfigValue)(this.config,h,ge,De,me)}getCleanupCooldown(){return(0,c.readIntConfigValue)(this.config,h,be,Ne,Le)}getCacheFolderName(){return(0,c.readStringConfigValue)(this.config,h,Ie,ye,Oe)}getCacheFolderLocation(){return(0,c.readStringConfigValue)(this.config,h,Pe,Fe,void 0)}};function Re(t,e){return JSON.stringify(t)===JSON.stringify(e)}function Se(t){let e=n.xfs.statSync(t);return{file:t,creationDate:e.mtime.getTime()}}async function Me(t,e){try{return await n.xfs.readFilePromise(t,e)}catch(r){if(r.code==="ENOENT")return;throw r}}async function we(t){let e=D.Configuration.create(t.cwd);return D.StreamReport.start({configuration:e,includeFooter:!1,stdout:t.stdout},async()=>{})}var Ve=async(t,e,r,a)=>{let i=await we(a.extra);t.push(new g(a.extra.cwd,a.project,r,i))},ve={beforeYarnScriptsCacheUsage:Ve},Te={hooks:ve},Ue=Te;return ee(Be);})();
return plugin;
}
};
