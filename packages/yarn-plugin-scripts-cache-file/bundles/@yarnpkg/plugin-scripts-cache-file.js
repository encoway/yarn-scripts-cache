/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-scripts-cache-file",
factory: function (require) {
"use strict";var plugin=(()=>{var B=Object.create;var E=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var D=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var h=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),w=(t,e)=>{for(var r in e)E(t,r,{get:e[r],enumerable:!0})},g=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of j(e))!U.call(t,a)&&a!==r&&E(t,a,{get:()=>e[a],enumerable:!(i=T(e,a))||i.enumerable});return t};var I=(t,e,r)=>(r=t!=null?B(H(t)):{},g(e||!t||!t.__esModule?E(r,"default",{value:t,enumerable:!0}):r,t)),x=t=>g(E({},"__esModule",{value:!0}),t);var p=h(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0})});var F=h(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0})});var m=h(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0})});var y=h(u=>{"use strict";Object.defineProperty(u,"__esModule",{value:!0});u.readBooleanConfigValue=u.readStringConfigValue=u.readIntConfigValue=void 0;function W(t,e,r,i,a){let o=process.env[r];return o&&!isNaN(parseInt(o))?parseInt(o):t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][i]=="number"?t.cacheConfigs[e][i]:a}u.readIntConfigValue=W;function Y(t,e,r,i,a){let o=process.env[r];return o||(t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][i]=="string"?t.cacheConfigs[e][i]:a)}u.readStringConfigValue=Y;function G(t,e,r,i,a){let o=process.env[r];return o?o==="true":t.cacheConfigs&&t.cacheConfigs[e]&&typeof t.cacheConfigs[e][i]=="boolean"?t.cacheConfigs[e][i]:a}u.readBooleanConfigValue=G});var N=h(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0})});var M=h(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0})});var R=h(c=>{"use strict";var X=c&&c.__createBinding||(Object.create?function(t,e,r,i){i===void 0&&(i=r);var a=Object.getOwnPropertyDescriptor(e,r);(!a||("get"in a?!e.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,a)}:function(t,e,r,i){i===void 0&&(i=r),t[i]=e[r]}),l=c&&c.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&X(e,t,r)};Object.defineProperty(c,"__esModule",{value:!0});l(p(),c);l(F(),c);l(m(),c);l(y(),c);l(N(),c);l(M(),c)});var ge={};w(ge,{default:()=>De});var n=D("@yarnpkg/fslib"),V=I(D("crypto")),s=I(R()),C="file",q=10,J="YSC_FILE_DISABLED",K="cacheDisabled",k=!1,$="YSC_FILE_READ_DISABLED",z="cacheReadDisabled",Q=!1,Z="YSC_FILE_WRITE_DISABLED",ee="cacheWriteDisabled",te=!1,re="YSC_FILE_MAX_AGE",ie="maxAge",ae=2592e6,ne="YSC_FILE_MAX_AMOUNT",oe="maxAmount",ce=1e3,se="YSC_FILE_CACHE_FOLDER_NAME",ue="cacheFolderName",Ce="yarn-scripts-cache",_e="YSC_FILE_CACHE_FOLDER_LOCATION",he="cacheFolderLocation",f=class{constructor(e,r,i){this.name=C,this.order=q,this.cwd=e,this.project=r,this.config=i}async saveCacheEntry(e){if(this.getCacheDisabled()||this.getCacheWriteDisabled())return;let r=this.buildCacheDir();await n.xfs.mkdirPromise(r,{recursive:!0});let i=this.buildCacheFile(r,e.key),a=JSON.stringify(e);await n.xfs.writeFilePromise(i,a),await this.cleanup()}async loadCacheEntry(e){if(this.getCacheDisabled()||this.getCacheReadDisabled())return;let r=this.buildCacheDir();if(!await n.xfs.existsPromise(r))return;let i=this.buildCacheFile(r,e);if(await n.xfs.existsPromise(i)){let a=await n.xfs.readFilePromise(i,"utf8"),o=JSON.parse(a);if(le(e,o.key))return o}}async cleanup(){let e=this.getMaxAge(),r=this.getMaxAmount(),i=Date.now()-e,a=this.buildCacheDir(),A=(await n.xfs.readdirPromise(a)).map(_=>n.ppath.join(a,_)).map(Ee);A.sort((_,v)=>v.creationDate-_.creationDate);let d=0;for(let _ of A)_.creationDate<i?await n.xfs.unlinkPromise(_.file):d+=1,d>r&&await n.xfs.unlinkPromise(_.file)}buildCacheFile(e,r){let i=V.default.createHash("sha512");return i.update(JSON.stringify(r)),n.ppath.join(e,`${i.digest("base64url")}.json`)}buildCacheDir(){let e=this.getCacheFolderLocation();if(e){let i=n.npath.toPortablePath(e);return n.npath.isAbsolute(e)?i:n.ppath.join(this.cwd,i)}let r=this.project.configuration.get("globalFolder");return n.ppath.join(r,this.getCacheFolderName())}getCacheDisabled(){return(0,s.readBooleanConfigValue)(this.config,C,J,K,k)}getCacheReadDisabled(){return(0,s.readBooleanConfigValue)(this.config,C,$,z,Q)}getCacheWriteDisabled(){return(0,s.readBooleanConfigValue)(this.config,C,Z,ee,te)}getMaxAge(){return(0,s.readIntConfigValue)(this.config,C,re,ie,ae)}getMaxAmount(){return(0,s.readIntConfigValue)(this.config,C,ne,oe,ce)}getCacheFolderName(){return(0,s.readStringConfigValue)(this.config,C,se,ue,Ce)}getCacheFolderLocation(){return(0,s.readStringConfigValue)(this.config,C,_e,he,void 0)}};function le(t,e){return JSON.stringify(t)===JSON.stringify(e)}function Ee(t){let e=n.xfs.statSync(t);return{file:t,creationDate:e.mtime.getTime()}}var fe=async(t,e,r)=>{t.push(new f(r.extra.cwd,r.project,e))},Ae={beforeYarnScriptsCacheUsage:fe},de={hooks:Ae},De=de;return x(ge);})();
return plugin;
}
};
