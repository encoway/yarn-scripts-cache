/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-build-result-cache",
factory: function (require) {
"use strict";var plugin=(()=>{var v=Object.create;var m=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var h=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var A=(t,e)=>{for(var r in e)m(t,r,{get:e[r],enumerable:!0})},E=(t,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of S(e))!D.call(t,o)&&o!==r&&m(t,o,{get:()=>e[o],enumerable:!(a=x(e,o))||a.enumerable});return t};var R=(t,e,r)=>(r=t!=null?v(U(t)):{},E(e||!t||!t.__esModule?m(r,"default",{value:t,enumerable:!0}):r,t)),K=t=>E(m({},"__esModule",{value:!0}),t);var I={};A(I,{default:()=>H});var f=h("@yarnpkg/core");var l=h("@yarnpkg/core"),u=h("@yarnpkg/fslib");function M(t,e){if(typeof t!="object")return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config is not an object!"),!1;if(!Array.isArray(t.scriptsToCache))return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config.scriptsToCache is not an array!"),!1;if(t.scriptsToCache.find(r=>typeof r!="string")!==void 0)return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config.scriptsToCache should only contain strings!"),!1;if(t.remoteCaches){if(!Array.isArray(t.remoteCaches))return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config.remoteCaches is not an array!"),!1;if(t.remoteCaches.find(r=>typeof r!="string")!==void 0)return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config.remoteCaches should only contain strings!"),!1;if(t.remoteCaches.find(r=>!O(r))!==void 0)return e.reportError(l.MessageName.UNNAMED,"build-result-cache-rc.json is not valid: config.remoteCaches should only contain valid URLs!"),!1}return!0}function O(t){try{return new URL(t),!0}catch{return!1}}async function b(t,e){let r=u.ppath.join(t,(0,u.toFilename)("build-result-cache-rc.json"));if(await u.xfs.existsPromise(r)){let a=await u.xfs.readFilePromise(r,"utf-8");try{let o=JSON.parse(a);if(M(o,e))return o}catch(o){e.reportErrorOnce(l.MessageName.EXCEPTION,"build-result-cache-rc.json is not valid:"),e.reportExceptionOnce(o)}}}var c=h("@yarnpkg/fslib"),y=class{constructor(e){this.cwd=e}async saveCacheEntry(e){let r=Date.now().toString()+".json",a=JSON.stringify(e),o=c.ppath.join(this.cwd,(0,c.toFilename)(".build-result-cache"));await c.xfs.mkdirPromise(o,{recursive:!0});let i=c.ppath.join(o,(0,c.toFilename)(r));await c.xfs.writeFilePromise(i,a)}async loadCacheEntry(e){let r=c.ppath.join(this.cwd,(0,c.toFilename)(".build-result-cache"));if(!await c.xfs.existsPromise(r))return;let a=await c.xfs.readdirPromise(r);for(let o of a){let i=c.ppath.join(r,o),s=await c.xfs.readFilePromise(i,"utf8"),d=JSON.parse(s);if(L(e,d.key))return d}}};function L(t,e){return JSON.stringify(t)===JSON.stringify(e)}var p=class{constructor(e){this.url=e}async saveCacheEntry(e){}async loadCacheEntry(e){}};function w(t,e){let r=[new y(t)];return e.remoteCaches&&e.remoteCaches.forEach(a=>r.push(new p(new URL(a)))),r}var n=h("@yarnpkg/fslib"),g=R(h("crypto"));async function j(t,e,r){let a=await N(t,e),o=await T(t),i={key:a,value:o};for(let s of r)await s.saveCacheEntry(i)}async function F(t,e,r){let a=await N(t,e);for(let o of r){let i=await o.loadCacheEntry(a);if(i)return await k(t,i.value),!0}return!1}async function N(t,e){let r=n.ppath.join(t,(0,n.toFilename)("src")),a=await C(r),o={};for(let i of a){let s=n.ppath.relative(r,i);o[s]=await W(i)}return{fileHashes:o}}async function W(t){let e=g.default.createHash("md5"),r=await n.xfs.readFilePromise(t);return e.update(r),e.digest("base64")}async function T(t){let e=n.ppath.join(t,(0,n.toFilename)("bin")),r=await C(e),a={};for(let o of r){let i=n.ppath.relative(e,o);a[i]=await n.xfs.readFilePromise(o,"utf8")}return{fileContents:a}}async function k(t,e){let r=n.ppath.join(t,(0,n.toFilename)("bin"));for(let[a,o]of Object.entries(e.fileContents)){let i=n.ppath.join(r,a),s=n.ppath.dirname(i);await n.xfs.mkdirPromise(s,{recursive:!0}),await n.xfs.writeFilePromise(i,o)}}async function C(t){let e=[],r=await n.xfs.readdirPromise(t);for(let a of r){let o=n.ppath.join(t,a),i=await n.xfs.statPromise(o);i.isFile()?e.push(o):i.isDirectory()&&e.push(...await C(o))}return e}async function B(t){let e=f.Configuration.create(t.cwd);return f.StreamReport.start({configuration:e,includeFooter:!1,stdout:t.stdout},async()=>{})}var V=async(t,e,r,a,o)=>{let i=await B(o),s=await b(o.cwd,i);if(s&&s.scriptsToCache.includes(a)){let d=w(o.cwd,s);return async()=>{if(await F(o.cwd,e,d))return i.reportInfo(f.MessageName.UNNAMED,"Build result was restored from cache!"),Promise.resolve(0);{let P=await t();return P===0&&(await j(o.cwd,e,d),i.reportInfo(f.MessageName.UNNAMED,"Build result cache was updated!")),P}}}else return t},J={hooks:{wrapScriptExecution:V}},H=J;return K(I);})();
return plugin;
}
};
